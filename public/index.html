const itemsContainer = document.getElementById("itemsContainer");
const addItemBtn = document.getElementById("addItem");
const submitBtn = document.getElementById("submitBtn");

function createItemInput() {
  const div = document.createElement("div");
  div.classList.add("item");
  div.innerHTML = `
    <input type="text" placeholder="Item name" class="itemName" required />
    <input type="text" placeholder="Description" class="itemDesc" />
  `;
  itemsContainer.appendChild(div);
}

addItemBtn.addEventListener("click", createItemInput);

submitBtn.addEventListener("click", async () => {
  const itemEls = document.querySelectorAll(".item");
  const items = Array.from(itemEls).map(el => ({
    name: el.querySelector(".itemName").value,
    desc: el.querySelector(".itemDesc").value
  })).filter(i => i.name.trim() !== "");

  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;

  if (items.length === 0) return alert("Add at least one item");

  const res = await fetch("/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ items, name, email })
  });

  const data = await res.json();
  if (data.error) return alert(data.error);

  // Show QR code
  const qrDiv = document.getElementById("qrDiv");
  qrDiv.innerHTML = `<img src="${data.qr}" alt="QR code" /><p>Tracking URL: <a href="${data.url}" target="_blank">${data.url}</a></p>`;
  setTimeout(() => location.reload(), 60000); // back to start after 1 min
});
